You can use the function **install.packages()** to install the packages.
#| eval: false
# Install packages not yet installed
# get packages already installed
installed_packages <- packages %in% rownames(installed.packages())
# If the packages are installed skip if not install them
if (any(installed_packages == FALSE)) {
install.packages(packages[!installed_packages], dependencies = TRUE)
}
library(tidyverse)
library(ape)
library(geiger)
library(caper)
library(phytools)
library(rr2)
## Trait data
furnaData <- read_csv("https://raw.githubusercontent.com/jesusNPL/BiodiversityScience/master/Spring2026/Lab_1_Intro_PCM/Data/furnariides_traits.csv") %>%
column_to_rownames("Sciname") %>%   # we are using the column "Sciname" as rownames
drop_na(Range.Size)
## Phylogenetic data
furnaTree <- read.nexus("https://raw.githubusercontent.com/jesusNPL/BiodiversityScience/master/Spring2026/Lab_1_Intro_PCM/Data/furnariides_tree.nex")
main.dir <- getwd() # Will get the working directory
# create a Data folder
dir.create("Data")
# url to download the data in your computer
urls <- "https://www.dropbox.com/scl/fi/3vr6yi0y32c36u5rgqlyp/Lab_1.zip?rlkey=s136jvkwsi6979hb5tlosxqh5&dl=1" # Name of the file to download
# download the file in a specific folder
download.file(url = urls, file.path(main.dir, "Data/Lab_1.zip"), mode = "wb")
# Unzip the downloaded files
unzip("Data/Lab_1.zip")
glimpse(furnaData)
tmp <- name.check(phy = furnaTree, data = furnaData)
# print the results
tmp
furnaTree <- drop.tip(phy = furnaTree, tip = tmp$tree_not_data)
name.check(phy = furnaTree, data = furnaData)
#| eval: true
plot(furnaTree)
#| eval: true
plot.phylo(furnaTree,
no.margin = TRUE,
cex = 0.5)
plot.phylo(furnaTree,
type = "fan",
no.margin = TRUE,
cex = 0.3)
#| eval: true
furnaTree
#| eval: true
str(furnaTree)
#| eval: false
furnaTree$tip.label
#| eval: false
furnaTree$Nnode
#| eval: false
furnaTree$edge
#| eval: true
plot.phylo(furnaTree,
type = "fan",
no.margin = TRUE,
cex = 0.7,
label.offset = 0.1,
show.tip.label = FALSE)
nodelabels(cex = 0.5)
tiplabels(cex = 0.5)
#| eval: true
furnaVariables <- names(furnaData)[c(9:19, 25:ncol(furnaData))]
furnaVariables
furnariidaeData <- furnaData %>%
filter(Family3 == "Furnariidae")
furnariidaeTree <- drop.tip(phy = furnaTree,
tip = setdiff(furnaTree$tip.label, rownames(furnariidaeData)))
hwi <- furnariidaeData[, "Hand-Wing.Index"]
names(hwi) <- rownames(furnariidaeData)
# data vectors have to be labelled with tip names for the associated tree.
# This is how to do that.
hist(hwi)
hist(log(hwi))
par(mfrow = c(1, 2))
hist(hwi)
hist(log(hwi))
#| eval: true
brownianModel <- fitContinuous(phy = furnariidaeTree,
dat = log(hwi))
brownianModel # this will show you the fit statistics and parameter values
mean(furnariidaeData$`Hand-Wing.Index`)
mean(log(hwi))
mean(hwi)
#| eval: true
## Calculate number of trait shifts
obj <- contMap(furnariidaeTree,
log(hwi),
fsize = 0.1,
lwd = 2,
type = "fan",
plot = FALSE)
# change colors
obj <- setMap(obj,
c("white", "#FFFFB2", "#FECC5C", "#FD8D3C", "#E31A1C"))
# Plot the results
plot(obj,
fsize = c(0.2, 0.8),
leg.txt = "Hand-Wing Index")
plot(obj,
fsize = c(0.6, 0.8),
type = "fan",
leg.txt = "Hand-Wing Index")
#| eval: true
rangeSize <- furnariidaeData[, "Range.Size"]
names(rangeSize) <- rownames(furnariidaeData)
#| eval: true
hist(log(rangeSize))
#| eval: true
furnaData %>%
drop_na(Range.Size) %>%
ggplot(aes(x = log(`Hand-Wing.Index`), y = log(Range.Size))) +
geom_point(alpha = 0.5, color = "darkgray", size = 3) +
labs(x = "log(Hand-Wing Index)", y = "log(Range Size)")
#| eval: true
lm_hwi_rangesize <- lm(log(rangeSize) ~ log(hwi))
summary(lm_hwi_rangesize)
#| eval: true
furnaData %>%
drop_na(Range.Size) %>%
ggplot(aes(x = log(Range.Size), y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray", size = 3) +
labs(x = "log(Hand-Wing Index)", y = "log(Range Size)")
#| eval: true
lm_hwi_rangesize <- lm(log(rangeSize) ~ log(hwi))
summary(lm_hwi_rangesize)
furnaData %>%
drop_na(Range.Size) %>%
ggplot(aes(x = log(Range.Size), y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Hand-Wing Index)", y = "log(Range Size)") +
geom_smooth(method = "lm")
#| eval: true
furnaData %>%
drop_na(Range.Size) %>%
ggplot(aes(x = log(Range.Size), y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray", size = 3) +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)")
furnaData %>%
drop_na(Range.Size) %>%
ggplot(aes(x = log(Range.Size), y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)") +
geom_smooth(method = "lm")
#| eval: true
lm_hwi_rangesize <- lm(log(hwi) ~ log(rangeSize))
summary(lm_hwi_rangesize)
round(0.018481, 2)
### Prepare data
furnariidaeTree$node.label <- NULL
furnariidaeData
## Traits
furnariidaeData <- furnariidaeData %>%
mutate(species = gsub(" ", "_", Species3)) %>%
select(species, `Hand-Wing.Index`, Range.Size)
## Traits
furnariidaeData <- furnariidaeData %>%
mutate(species = gsub(" ", "_", Species3)) %>%
dplyr::select(species, `Hand-Wing.Index`, Range.Size)
furnariidaeData
furnariidaeData
## Create comparative.data object for further analyses
compData <- caper::comparative.data(
phy = furnariidaeTree,
data = furnariidaeData
names.col = "species",
## Create comparative.data object for further analyses
compData <- caper::comparative.data(
phy = furnariidaeTree,
data = furnariidaeData,
names.col = "species",
vcv.dim = TRUE,
warn.dropped = FALSE
)
pglsModel <- pgls(log(`Hand-Wing.Index`) ~ log(Range.Size),
lambda = "ML",
data = compData)
summary(pglsModel)
#| eval: true
summary(pglsModel)
coef(pglsModel)
# R2lik is based on the likelihood of fitted models and therefore reflects the amount of information that the models contain.
#And R2lik is most appropriate to assess the importance of different components within the same model applied to the same data, because it is most closely associated with statistical significance tests.
R2_lik(mod = pglsModel)
#| eval: true
summary(pglsModel)
coef(pglsModel)
furnariidaeData %>%
ggplot(aes(x = log(Range.Size)) , y = log(`Hand-Wing.Index`)) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "Hand-Wing Index")
furnariidaeData %>%
ggplot(aes(x = log(Range.Size)) , y = log(`Hand-Wing.Index`)) +
geom_point(alpha = 0.5, color = "darkgray")
furnariidaeData %>%
ggplot(aes(x = log(Range.Size) , y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "Hand-Wing Index")
coef(pglsModel)[1]
coef(pglsModel)[2]
#| eval: true
furnariidaeData %>%
ggplot(aes(x = log(Range.Size) , y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)") +
#geom_smooth(method = "lm") +
geom_abline(intercept = coef(pglsModel)[1], slope = coef(pglsModel)[2],
color = "red", linewidth = 1.5)
# will plot the pgls regression line on your biplot.
#| eval: true
furnariidaeData %>%
ggplot(aes(x = log(Range.Size) , y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)") +
#geom_smooth(method = "lm") +
geom_abline(intercept = coef(pglsModel)[1], slope = coef(pglsModel)[2],
color = "red", linewidth = 1.5)
# will plot the pgls regression line on your biplot.
coef(pglsModel)
round(0.01543412, 2)
0.04*100
## Loglik of the PGLS model
logLik(pglsModel)
## Estimate null model or intercept-only model
y <- as.numeric(fitted(pglsModel) + resid(pglsModel))
nullModel <- lm(y ~ 1)
## loglik null model
logLik(nullModel)
## Is higher
logLik(pglsModel) > logLik(nullModel)
## Loglik of the PGLS model
logLik(pglsModel)
## loglik null model
logLik(nullModel)
summary(pglsModel)
#| eval: true
olsModel <- lm(log(hwi) ~ log(rangeSize))
summary(olsModel)
furnariidaeData %>%
ggplot(aes(x = log(Range.Size) , y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)") +
geom_smooth(method = "lm") +
geom_abline(intercept = coef(pglsModel)[1], slope = coef(pglsModel)[2],
color = "red", linewidth = 1.5)
sqrt(pglsModel$varBeta[2, 2]
)
#| eval: true
brownianModel <- fitContinuous(phy = furnariidaeTree, # phylogeny
dat = log(hwi), # trait
model = "BM") # evolutionary model
#| eval: true
brownianModel <- fitContinuous(phy = furnariidaeTree, # phylogeny
dat = log(hwi), # trait
model = "BM") # evolutionary model
#| eval: true
OUModel <- fitContinuous(phy = furnariidaeTree,
dat = log(hwi),
model = "OU")
#| eval: true
EBModel <- fitContinuous(phy = furnariidaeTree,
dat = log(hwi),
model = "EB")
#| eval: false
brownianModel
OUModel
EBModel
#| eval: true
# Vector of models
mods <- c(brownianModel$opt$aicc, OUModel$opt$aicc, EBModel$opt$aicc)
# rename the models
names(mods) <- c("BM", "OU", "EB")
# Run AIC weights
aicw(mods)
library(knitr)
aic_HWI <- aicw(mods)
names(aic_HWI)[1] <- "AIC"
aic_HWI$lnL <- c(brownianModel$opt$lnL, OUModel$opt$lnL, EBModel$opt$lnL)
kable(aic_HWI)
#| eval: false
# Package vector names
packages <- c("tidyverse", "ape", "geiger", "caper", "phytools", "knitr")
aic_HWI <- aicw(mods)
names(aic_HWI)[1] <- "AIC"
aic_HWI$lnL <- c(brownianModel$opt$lnL, OUModel$opt$lnL, EBModel$opt$lnL)
kable(aic_HWI)
BM_RS <- fitContinuous(phy = furnariidaeTree, # phylogeny
dat = log(rangeSize), # trait
model = "BM") # evolutionary model
OU_RS <- fitContinuous(phy = furnariidaeTree,
dat = log(rangeSize),
model = "OU")
EB_RS <- fitContinuous(phy = furnariidaeTree,
dat = log(rangeSize),
model = "EB")
# Vector of models
mods_RS <- c(BM_RS$opt$aicc, OU_RS$opt$aicc, EB_RS$opt$aicc)
# rename the models
names(mods_RS) <- c("BM", "OU", "EB")
# Run AIC weights
aic_RS <- aicw(mods_RS)
names(aic_RS)[1] <- "AIC"
aic_RS$lnL <- c(BM_RS$opt$lnL, OU_RS$opt$lnL, EB_RS$opt$lnL)
kable(aic_RS)
#| eval: true
furnariidaeData %>%
ggplot(aes(x = log(Range.Size), y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)") +
geom_smooth(method = "lm", se = FALSE, linewidth = 1.5) + # OLS slope
geom_abline(intercept = coef(pglsModel)[1], # PGLS slope
slope = coef(pglsModel)[2],
color = "red", linewidth = 1.5)
ols.sum <- summary(olsModel)
ols.sum
ols.sum$coef
ols.sum$coefficients
ols.sum$coefficients[2, 1]
ols.sum$coefficients[2, 2]
# for the uncorrected linear model, the 95% CI is
ols.sum$coefficients[2, 1] + # slope
c(-1.96, 1.96)*ols.sum$coefficients[2, 2] #standard error
### PGLS model
pgls.sum <- summary(pglsModel)
pglsModel$model
pglsModel$fitted
coef(pglsModel)
summary(pglsModel)
coef(pglsModel)
pglsModel$param.CI
pglsModel$sterr
# for Brownian Motion, the 95% CI is
coef(pglsModel)[2] + c(-1.96, 1.96)*pglsModel$sterr[2]
pgls.sum$coefficients
coef(pglsModel)[2]
coef(pglsModel)[2, 1]
pgls.sum$coefficients[2, 1]
pgls.sum$coefficients[2, 2]
pgls.sum$coefficients[2, 1] + c(-1.96, 1.96)*pgls.sum[2, 2]
pgls.sum$coefficients[2, 1] + c(-1.96, 1.96)*pgls.sum$coefficients[2, 2]
#| eval: true
### OLS model
ols.sum <- summary(olsModel)
# for the uncorrected linear model, the 95% CI is
ols.sum$coefficients[2, 1] + # slope
c(-1.96, 1.96)*ols.sum$coefficients[2, 2] #standard error
### PGLS model
pgls.sum <- summary(pglsModel)
# for Brownian Motion, the 95% CI is
pgls.sum$coefficients[2, 1] + c(-1.96, 1.96)*pgls.sum$coefficients[2, 2]
furnariidaeData %>%
ggplot(aes(x = log(Range.Size), y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)") +
geom_smooth(method = "lm", se = FALSE, linewidth = 1.5) + # OLS slope
# add CI to OLS model
geom_abline(intercept = ols.sum$coefficients[1, 1] + c(-1.96, 1.96)*ols.sum$coefficients[1, 2], #standard error, # PGLS slope
slope = ols.sum$coefficients[1, 1] + c(-1.96, 1.96)*ols.sum$coefficients[1, 2],
color = "red", linewidth = 1.5)
furnariidaeData %>%
ggplot(aes(x = log(Range.Size), y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)") +
geom_smooth(method = "lm", se = FALSE, linewidth = 1.5) + # OLS slope
# add CI to OLS model
geom_abline(intercept = ols.sum$coefficients[1, 1] + c(-1.96, 1.96)*ols.sum$coefficients[1, 2], #standard error, # PGLS slope
slope = ols.sum$coefficients[2, 1] + c(-1.96, 1.96)*ols.sum$coefficients[2, 2],
color = "red", linewidth = 1.5)
furnariidaeData %>%
ggplot(aes(x = log(Range.Size), y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)") +
geom_smooth(method = "lm", se = FALSE, linewidth = 1.5) + # OLS slope
# add CI to OLS model
geom_abline(intercept = ols.sum$coefficients[1, 1] + c(-1.96, 1.96)*ols.sum$coefficients[1, 2], # CI intercept
slope = ols.sum$coefficients[2, 1] + c(-1.96, 1.96)*ols.sum$coefficients[2, 2], # CI slope
color = "blue", linewidth = 1) +
geom_abline(intercept = coef(pglsModel)[1], # PGLS slope
slope = coef(pglsModel)[2],
color = "red", linewidth = 1.5)
#| eval: true
furnariidaeData %>%
ggplot(aes(x = log(Range.Size), y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)") +
geom_smooth(method = "lm", se = FALSE, linewidth = 1.5) + # OLS slope
# add CI to OLS model
geom_abline(intercept = ols.sum$coefficients[1, 1] + c(-1.96, 1.96)*ols.sum$coefficients[1, 2], # CI intercept
slope = ols.sum$coefficients[2, 1] + c(-1.96, 1.96)*ols.sum$coefficients[2, 2], # CI slope
color = "blue", linewidth = 1) +
geom_abline(intercept = coef(pglsModel)[1], # PGLS slope
slope = coef(pglsModel)[2],
color = "red", linewidth = 1.5)
#| eval: true
furnariidaeData %>%
ggplot(aes(x = log(Range.Size), y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)") +
geom_smooth(method = "lm", se = FALSE, linewidth = 1.5) + # OLS slope
# add CI to OLS model
geom_abline(intercept = ols.sum$coefficients[1, 1] + c(-1.96, 1.96)*ols.sum$coefficients[1, 2], # CI intercept
slope = ols.sum$coefficients[2, 1] + c(-1.96, 1.96)*ols.sum$coefficients[2, 2], # CI slope
color = "blue", linewidth = 1, linetype = 2) +
geom_abline(intercept = coef(pglsModel)[1], # PGLS slope
slope = coef(pglsModel)[2],
color = "red", linewidth = 1.5)
#| eval: true
furnariidaeData %>%
ggplot(aes(x = log(Range.Size), y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)") +
geom_smooth(method = "lm", se = FALSE, linewidth = 1.5) + # OLS slope
# add CI to OLS model
geom_abline(intercept = ols.sum$coefficients[1, 1] + c(-1.96, 1.96)*ols.sum$coefficients[1, 2], # CI intercept
slope = ols.sum$coefficients[2, 1] + c(-1.96, 1.96)*ols.sum$coefficients[2, 2], # CI slope
color = "blue", linewidth = 1, linetype = 2) +
geom_abline(intercept = coef(pglsModel)[1], # PGLS slope
slope = coef(pglsModel)[2],
color = "red", linewidth = 1.5) +
# add CI PGLS model
geom_abline(intercept = pgls.sum$coefficients[1, 1] + c(-1.96, 1.96)*pgls.sum$coefficients[1, 2], # CI intercept
slope = pgls.sum$coefficients[2, 1] + c(-1.96, 1.96)*pgls.sum$coefficients[2, 2], # CI slope
color = "red", linewidth = 1, linetype = 2)
pgls.sum$coefficients[1, 1]
pgls.sum$coefficients
pgls.sum$coefficients[1, 2]
#| eval: true
furnariidaeData %>%
ggplot(aes(x = log(Range.Size), y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)") +
geom_smooth(method = "lm", se = FALSE, linewidth = 1.5) + # OLS slope
# add CI to OLS model
# geom_abline(intercept = ols.sum$coefficients[1, 1] + c(-1.96, 1.96)*ols.sum$coefficients[1, 2], # CI intercept
#             slope = ols.sum$coefficients[2, 1] + c(-1.96, 1.96)*ols.sum$coefficients[2, 2], # CI slope
#             color = "blue", linewidth = 1, linetype = 2) +
geom_abline(intercept = coef(pglsModel)[1], # PGLS slope
slope = coef(pglsModel)[2],
color = "red", linewidth = 1.5) +
# add CI PGLS model
geom_abline(intercept = pgls.sum$coefficients[1, 1] + c(-1.96, 1.96)*pgls.sum$coefficients[1, 2], # CI intercept
slope = pgls.sum$coefficients[2, 1] + c(-1.96, 1.96)*pgls.sum$coefficients[2, 2], # CI slope
color = "red", linewidth = 1, linetype = 2)
#| eval: true
furnariidaeData %>%
ggplot(aes(x = log(Range.Size), y = log(`Hand-Wing.Index`))) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "log(Range Size)", y = "log(Hand-Wing Index)") +
geom_smooth(method = "lm", se = FALSE, linewidth = 1.5) + # OLS slope
# add CI to OLS model
geom_abline(intercept = ols.sum$coefficients[1, 1] + c(-1.96, 1.96)*ols.sum$coefficients[1, 2], # CI intercept
slope = ols.sum$coefficients[2, 1] + c(-1.96, 1.96)*ols.sum$coefficients[2, 2], # CI slope
color = "blue", linewidth = 1, linetype = 2) +
geom_abline(intercept = coef(pglsModel)[1], # PGLS slope
slope = coef(pglsModel)[2],
color = "red", linewidth = 1.5) +
# add CI PGLS model
geom_abline(intercept = pgls.sum$coefficients[1, 1] + c(-1.96, 1.96)*pgls.sum$coefficients[1, 2], # CI intercept
slope = pgls.sum$coefficients[2, 1] + c(-1.96, 1.96)*pgls.sum$coefficients[2, 2], # CI slope
color = "red", linewidth = 1, linetype = 2)
#| eval: true
# Run Blomberg's K
K_hwi <- phylosig(tree = furnariidaeTree, # Phylogeny
x = hwi, # trait
method = "K", # method
test = TRUE)
# Print results
print(K_hwi)
# Plot results
plot(K_hwi)
#| eval: true
# Run Pagel's Lambda
LB_hwi <- phylosig(tree = furnaTree,
x = hwi,
method = "lambda",
test = TRUE)
# Print the results
print(LB_hwi)
# Plot thre results
plot(LB_hwi)
# Run Blomberg's K
K_rs <- phylosig(tree = furnariidaeTree, # Phylogeny
x = rangeSize, # trait
method = "K", # method
test = TRUE)
# Print results
print(K_rs)
# Plot results
plot(K_rs)
# Run Pagel's Lambda
LB_rs <- phylosig(tree = furnariidaeTree,
x = rangeSize,
method = "lambda",
test = TRUE)
# Print the results
print(LB_rs)
# Plot thre results
plot(LB_rs)
#| eval: true
# Run Pagel's Lambda
LB_hwi <- phylosig(tree = furnariidaeTree,
x = hwi,
method = "lambda",
test = TRUE)
# Print the results
print(LB_hwi)
# Plot thre results
plot(LB_hwi)
