frangesVars
#| eval: true
selSPP <- franges %>%
filter(SCINAME == "Furnarius rufus" | SCINAME == "Anabazenops dorsalis")
# country subset
SApoly <- worldMap %>%
filter(continent == "South America")
#| eval: true
# plot the selected ranges
ggplot() +
geom_sf(data = SApoly) +
geom_sf(data = selSPP, aes(color = SCINAME), alpha = 0.7, size = 2) +
scale_fill_scico_d(palette = "davos", direction = -1,
end = 0.9, guide = FALSE) +
coord_sf(
xlim = c(-80, -35),
ylim = c(10, -60)
) +
theme(
plot.background = element_rect(fill = "#f1f2f3"),
panel.background = element_rect(fill = "lightblue"),
panel.grid = element_blank(),
line = element_blank(),
rect = element_blank()
)
#| eval: true
# Create raster ro store richness values
neo_ras <- rast() # empty raster
ext(neo_ras) <- ext(franges) # Set the raster "extent"
res(neo_ras) <- 1 # Set the raster "resolution"
neo_ras # print the raster object in the console
values(neo_ras) <- 0 # assign O values to all pixels in the raster
#| eval: true
# transform the sf object to a sp object
SApoly_sp <- as(SApoly, "Spatial")
# Plot empty raster
plot(neo_ras)
plot(SApoly_sp, add = TRUE) ## overlay SA countries to the SR map
#| eval: true
f_sr_raster <- terra::rasterizeGeom(x = vect(franges), # species geographical ranges
y = neo_ras, # empty raster
fun = "count" # count number of species per grid cell
)
# this process can take a while depending on your computer (~45 secs in Jesús's computer), please be patient.
#| eval: true
plot(f_sr_raster)
#| eval: true
# country subset
Apoly <- worldMap %>%
filter(continent == "South America" | continent == "North America")
# transform the sf object to a sp object
Apoly_sp <- as(Apoly, "Spatial")
# Plot the information
plot(mask(f_sr_raster, Apoly), # raster of species richness
col = viridis::turbo(10), # colors
zlim = c(min(values(f_sr_raster),
max(values(f_sr_raster)))),
main = "Furnariides species richness")
plot(Apoly_sp, add = TRUE) ## overlay SA countries to the SR map
#| eval: true
library(rasterVis)
library(RColorBrewer)
# First set a theme
mapTheme <- rasterTheme(region = rev(brewer.pal(11, "Spectral")),
layout.widths = list(right.padding = 10),
axis.line = list(col = "transparent"),
tick = list(col = 'transparent'))
## Now we can plot the raster
p_furna_SR <- levelplot(mask(f_sr_raster, Apoly),
maxpixels = 1e10,
margin = FALSE,
main = list('Furnariides \n species richness', col = 'darkgray'),
par.settings = mapTheme,
scales = list(x = list(draw = TRUE),
y = list(draw = TRUE)),
zlim = c(0, 180))
p_furna_SR
#| eval: true
# 2º degrees
neo_ras_2dg <- rast()
# Set the raster "extent"
ext(neo_ras_2dg) <- ext(franges)
res(neo_ras_2dg) <- 2
neo_ras_2dg
values(neo_ras_2dg) <- 0
# 4º degrees
neo_ras_4dg <- rast()
# Set the raster "extent"
ext(neo_ras_4dg) <- ext(franges)
res(neo_ras_4dg) <- 4
neo_ras_4dg
values(neo_ras_4dg) <- 0
# 8º degrees
neo_ras_8dg <- rast()
# Set the raster "extent"
ext(neo_ras_8dg) <- ext(franges)
res(neo_ras_8dg) <- 8
neo_ras_8dg
values(neo_ras_8dg) <- 0
#| eval: false
# Furnariides at 2º of long-lat
f_sr_2dg_raster <- terra::rasterizeGeom(x = vect(franges), # species geographical ranges
y = neo_ras_2dg, # empty raster
fun = "count" # count number of species per grid cell
)
# Furnariides at 4º of long-lat
f_sr_4dg_raster <- terra::rasterizeGeom(x = vect(franges), # species geographical ranges
y = neo_ras_4dg, # empty raster
fun = "count" # count number of species per grid cell
)
# Furnariides at 8º of long-lat
f_sr_8dg_raster <- terra::rasterizeGeom(x = vect(franges), # species geographical ranges
y = neo_ras_8dg, # empty raster
fun = "count" # count number of species per grid cell
)
#| eval: true
par(mfrow = c (2, 2))
## Map at 1 degree grid cell
plot(mask(f_sr_raster, Apoly), # raster of species richness
col = viridis::turbo(10), # colors
zlim = c(min(values(f_sr_raster),
max(values(f_sr_raster)))),
main = "Furnariides species richness 1 degree")
plot(Apoly_sp, add = TRUE)
## Map at 2 degrees grid cell
plot(mask(f_sr_2dg_raster, Apoly), # raster of species richness
col = viridis::turbo(10), # colors
zlim = c(min(values(f_sr_raster),
max(values(f_sr_raster)))),
main = "Furnariides species richness 2 degrees")
plot(Apoly_sp, add = TRUE)
## Map at 4 degrees grid cell
plot(mask(f_sr_4dg_raster, Apoly), # raster of species richness
col = viridis::turbo(10), # colors
zlim = c(min(values(f_sr_raster),
max(values(f_sr_raster)))),
main = "Furnariides species richness 4 degrees")
plot(Apoly_sp, add = TRUE)
## Map at 8 degrees grid cell
plot(mask(f_sr_8dg_raster, Apoly), # raster of species richness
col = viridis::turbo(10), # colors
zlim = c(min(values(f_sr_raster),
max(values(f_sr_raster)))),
main = "Furnariides species richness 8 degrees")
plot(Apoly_sp, add = TRUE)
#dev.off()
#| eval: false
franges
#| eval: true
f_MRD_raster <- terra::rasterize(vect(franges), # polygons
neo_ras, # empty raster
field = "RD", # Root distance
fun = mean # function mean
)
#| eval: true
plot(f_MRD_raster,
main = 'Furnariides mean root distance')
plot(Apoly_sp, add = TRUE)
#| eval: true
## Now we can plot the raster
p_furna_MRD <- levelplot(f_MRD_raster,
maxpixels = 1e10,
margin = FALSE,
main = list('Furnariides \n mean root distance', col = 'darkgray'),
par.settings = mapTheme,
scales = list(x = list(draw = TRUE),
y = list(draw = TRUE)),
zlim = c(0, 25))
p_furna_MRD
#| eval: true
par(mfrow = c(1, 2))
plot(mask(f_sr_raster, Apoly),
col = viridis::plasma(10),
main = "Furnariides species richness")
plot(mask(f_MRD_raster, Apoly),
col = viridis::plasma(10),
main = "Furnariides mean root distance")
#dev.off()
#| eval: true
cor.test(values(f_sr_raster), values(f_MRD_raster))
#| eval: true
obj <- lm(values(f_sr_raster) ~ values(f_MRD_raster))
summary(obj)
#| eval: true
# get pixel values from raster richness
data_sr <- as.data.frame(f_sr_raster, xy = TRUE)
# get pixel values from raster MRD
data_mrd <- as.data.frame(f_MRD_raster, xy = TRUE)
# Combine both datasets
data_sr_mrd <- left_join(data_sr, data_mrd, by = c("x", "y")) %>%
rename(SR = area, MRD = RD) %>%
drop_na(MRD)
# Plot the association
data_sr_mrd %>%
ggplot(aes(x = MRD, y = SR)) +
geom_point(color = "darkgray", size = 3, alpha = 0.5) +
geom_smooth(method = "lm")
#| eval: true
# Annual Mean Temperature
bio1 <- rast("Data/BioClim/bio1.bil")
bio1 <- bio1/10
# Annual Precipitation
bio12 <- rast("Data/BioClim/bio12.bil")
bio12
#| eval: true
plot(bio1)
plot(bio12)
#| eval: true
bio1_neo <- crop(bio1, ext(franges))
bio12_neo <- crop(bio12, ext(franges))
#| eval: true
par(mfrow = c(1, 2))
plot(bio1_neo, main = "Annual Mean Temperature",
col = rev(viridis::inferno(10)))
plot(bio12_neo, main = "Annual Precipitation",
col = rev(viridis::inferno(10)))
#| eval: true
# Get environmental data using coordinates from our maps
f_ras_bios <- extract(x = c(bio1_neo, bio12_neo), # environmental variables
y = data_sr_mrd[, c("x", "y")]) %>% # coordinates
rename(MAT = bio1, MAP = bio12)
# Combine the information
fdata <- bind_cols(data_sr_mrd, f_ras_bios)
head(fdata)
#| eval: true
cor.test(fdata$SR, fdata$MAT)
#| eval: true
cor.test(fdata$SR, fdata$MAP)
#| eval: true
lmbio1 <- lm(SR ~ MAT, data = fdata)
summary(lmbio1)
lmbio12 <- lm(SR ~ MAP, data = fdata)
summary(lmbio12)
round(2.471e-02, 3)
#| eval: true
fdata %>%
ggplot(aes(x = MAT, y = SR)) +
geom_point(color = "darkgray") +
geom_smooth(method = "lm")
fdata %>%
ggplot(aes(x = MAP, y = SR)) +
geom_point(color = "darkgray") +
geom_smooth(method = "lm")
round(0.2446 , 2)
round(0.4271, 2)
#| eval: true
fols <- lm(SR ~ MAT + MAP, data = fdata)
summary(fols)
#| eval: true
fols2 <- lm(SR ~ MAT + MAP + MRD, data = fdata)
summary(fols2)
round(0.5047, 2)
round(0.5047, 1)
round(0.5047, 3)
#| eval: true
autocor_SR <- ncf::correlog(fdata$x, # longitude
fdata$y, # latitude
z = fdata$SR, # species richness
na.rm = TRUE,
increment = 1,
resamp = 1)
#| eval: true
plot(autocor_SR$correlation[1:50],
type = "b", pch = 1, cex = 1.2, lwd = 1.5, ylim = c(-1, 1),
xlab = "Distance class",
ylab = "Moran's I",
cex.lab = 1.2,
cex.axis = 1.2)
abline(h = 0)
#| eval: true
coords <- fdata[1:2]
coords <- as.matrix(coords)
head(coords)
#| eval: true
# neighborhood contiguity by distance
nb1.5 <- spdep::dnearneigh(coords, 0, 1.5)
#| eval: true
nb1.5.w <- spdep::nb2listw(neighbours = nb1.5,
glist = NULL,
style = "W",
zero.policy = TRUE)
#| eval: true
residuals_ols <- residuals(fols2)
plot(residuals_ols)
#| eval: true
autocor_ols_res <- ncf::correlog(x = fdata$x,
y = fdata$y,
z = residuals(fols),
increment = 1,
resamp = 1)
#| eval: true
plot(autocor_ols_res$correlation[1:50],
type = "b", pch = 1, cex = 1.2, lwd = 1.5, ylim = c(-0.5, 1),
xlab = "distance",
ylab = "Moran's I",
cex.lab = 1.5,
cex.axis = 1.2)
abline(h = 0)
title(main = "OLS residuals", cex = 1.5)
#| eval: true
par(mfrow = c(2, 1))
# Plot SR
plot(autocor_SR$correlation[1:50],
type = "b", pch = 1, cex = 1.2,
lwd = 1.5, ylim = c(-1, 1),
xlab = "Distance class",
ylab = "Moran's I",
cex.lab = 1.2,
cex.axis = 1.2)
abline(h = 0)
title(main = "OLS model", cex = 1.5)
# Plot residuals SR
plot(autocor_ols_res$correlation[1:50],
type = "b", pch = 1, cex = 1.2,
lwd = 1.5, ylim = c(-0.5, 1),
xlab = "Distance class",
ylab = "Moran's I",
cex.lab = 1.5,
cex.axis = 1.2)
abline(h = 0)
title(main = "OLS residuals", cex = 1.5)
#| eval: true
sar_nb1.5.w <- spatialreg::errorsarlm(fols2,
listw = nb1.5.w,
data = fdata,
quiet = FALSE,
zero.policy = TRUE,
na.action = na.exclude)
# this will take a while, ~10 seconds in Jesús's computer
#| eval: true
summary(sar_nb1.5.w)
#| eval: true
residuals_sar_nb1.5.w <- residuals(sar_nb1.5.w)
#| eval: true
autocor_sar_nb1.5.w <- ncf::correlog(x = fdata$x,
y = fdata$y,
z = residuals(sar_nb1.5.w),
na.rm = TRUE,
increment = 1,
resamp = 1)
#| eval: true
plot(autocor_sar_nb1.5.w$correlation[1:50],
type = "b", pch = 4, cex = 1.2,
lwd = 1.5, ylim = c(-0.5, 1),
xlab = "distance",
ylab = "Moran's I",
cex.lab = 1.5,
cex.axis = 1.2)
abline(h = 0)
title(main = "SARerr residuals", cex = 1.5)
#| eval: true
par(mfrow = c(2, 1))
plot(autocor_ols_res$correlation[1:50],
type = "b", pch = 1, cex = 1.2,
lwd = 1.5, ylim = c(-0.5, 1),
xlab = "distance",
ylab = "Moran's I", cex.lab = 1.5,
cex.axis = 1.2)
abline(h = 0)
title(main = "OLS residuals", cex = 1.5)
plot(autocor_sar_nb1.5.w$correlation[1:50],
type = "b", pch = 4, cex = 1.2,
lwd = 1.5, ylim = c(-0.5, 1),
xlab = "distance",
ylab = "Moran's I",
cex.lab = 1.5,
cex.axis = 1.2)
abline(h = 0)
title(main = "SARerr residuals", cex = 1.5)
#| eval: true
summary(sar_nb1.5.w)
#| eval: true
summary(fols2)
#| eval: true
fdata %>%
ggplot(aes(x = MAT, y = SR)) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "Mean annual temperature",
y = "Species richness") +
geom_smooth(method = "lm", # coefficient OLS
se = FALSE,
color = "blue",
linewidth = 2) +
geom_abline(intercept = coef(sar_nb1.5.w)[2], # coefficients SAR
slope = coef(sar_nb1.5.w)[3],
color = "red",
linewidth = 2)
#| eval: true
fdata %>%
ggplot(aes(x = MAP, y = SR)) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "Annual precipitation",
y = "Species richness") +
geom_smooth(method = "lm", # coefficient OLS
se = FALSE,
color = "blue",
linewidth = 2) +
geom_abline(intercept = coef(sar_nb1.5.w)[2], # coefficients SAR
slope = coef(sar_nb1.5.w)[4],
color = "red",
linewidth = 2)
#| eval: true
fdata %>%
ggplot(aes(x = MRD, y = SR)) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "Mean annual temperature",
y = "Species richness") +
geom_smooth(method = "lm", # coefficient OLS
se = FALSE,
color = "blue",
linewidth = 2) +
geom_abline(intercept = coef(sar_nb1.5.w)[2], # coefficients SAR
slope = coef(sar_nb1.5.w)[5],
color = "red",
linewidth = 2)
#| eval: true
fdata %>%
ggplot(aes(x = MRD, y = SR)) +
geom_point(alpha = 0.5, color = "darkgray") +
labs(x = "Mean root distance",
y = "Species richness") +
geom_smooth(method = "lm", # coefficient OLS
se = FALSE,
color = "blue",
linewidth = 2) +
geom_abline(intercept = coef(sar_nb1.5.w)[2], # coefficients SAR
slope = coef(sar_nb1.5.w)[5],
color = "red",
linewidth = 2)
#| eval: true
source("https://raw.githubusercontent.com/jesusNPL/BetaDivNA/master/SARr2.R")
#| eval: true
SARr2(Lfull = sar_nb1.5.w$LL, # log likelihood of the model that includes the spatial weights
Lnull = sar_nb1.5.w$logLik_lm.model, # log likelihood null model
N = nrow(fdata) # number of observation
)
sar_nb1.5.w$LL
sar_nb1.5.w$logLik_lm.model,
sar_nb1.5.w$logLik_lm.model
sar_nb1.5.w$logLik_lm.model[1]
sar_nb1.5.w$LL[1]
#| eval: true
SARr2(Lfull = sar_nb1.5.w$LL[[1]], # log likelihood of the model that includes the spatial weights
Lnull = sar_nb1.5.w$logLik_lm.model[[1]], # log likelihood null model
N = nrow(fdata) # number of observation
)
sar_nb1.5.w$dvars
sar_nb1.5.w$LL
sar_nb1.5.w$coefficients
coef(sar_nb1.5.w)
sar_nb1.5.w
summary(sar_nb1.5.w)
nrow(fdata)
summary(sar_nb1.5.w)[1]
summary(sar_nb1.5.w)[2]
summary(sar_nb1.5.w)[[1]]
summary(sar_nb1.5.w)[[4]]
summary(sar_nb1.5.w)[[5]]
summary(sar_nb1.5.w)[[6]]
summary(sar_nb1.5.w)[[10]]
summary(sar_nb1.5.w)[[15]]
summary(sar_nb1.5.w)[[12]]
sar_nb1.5.w
sar_nb1.5.w$opt$maximum
sar_nb1.5.w$opt$objective
View(SARr2)
rr2::R2_lik(sar_nb1.5.w)
rr2::R2(sar_nb1.5.w)
?rr2::R2
summary(sar_nb1.5.w)
coef(fols2)
coef(fols2)/2
sar_nb1.5.w$LL[[1]]
sar_nb1.5.w$logLik_lm.model[[1]]
sar_nb1.5.w$logLik_lm.model
sar_nb1.5.w$LLNullLlm
sar_nb1.5.w$LLNullLlm[[1]]
SARr2(Lfull = sar_nb1.5.w$LL[[1]], # log likelihood of the model that includes the spatial weights
Lnull = -8102.319#sar_nb1.5.w$logLik_lm.model[[1]], # log likelihood null model
N = nrow(fdata) # number of observation
SARr2(Lfull = sar_nb1.5.w$LL[[1]], # log likelihood of the model that includes the spatial weights
Lnull = -8102.319,#sar_nb1.5.w$logLik_lm.model[[1]], # log likelihood null model
N = nrow(fdata) # number of observation
)
SARr2(Lfull = sar_nb1.5.w$LL[[1]], # log likelihood of the model that includes the spatial weights
Lnull = sar_nb1.5.w$logLik_lm.model[[1]], # log likelihood null model
N = nrow(fdata) # number of observation
)
summary(fols2)
summary(fols)
round(0.8350546, 2)
#| eval: true
sf_use_s2(FALSE)
# Get world map from the {rnaturalearthdata} package
worldMap <- ne_countries(scale = "medium", type = "countries", returnclass = "sf")
# cCountry subset - The United States and Mexico
NApoly <- worldMap %>%
filter(admin == "United States of America" | admin == "Mexico")
# trim to study area
limsNA <- st_buffer(NApoly, dist = 1) %>%
st_bbox()
# neighboring countries
adjacentPolys <- st_touches(NApoly, worldMap)
neighbours <- worldMap %>%
slice(pluck(adjacentPolys, 1))
#| eval: true
library(scico)
library(rnaturalearth)
library(smoothr)
library(tidyverse)
library(terra)
library(sf)
